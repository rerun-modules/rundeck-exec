<!DOCTYPE html>
<html>
<head>
    <meta http-equiv='content-type' content='text/html;charset=utf-8'>
    <title>status</title>
    <link rel="stylesheet" media="all" href="http://jashkenas.github.io/docco/resources/linear/public/stylesheets/normalize.css" />
    <link rel="stylesheet" media="all" href="http://jashkenas.github.io/docco/resources/linear/docco.css" />
</head>
<body>
<div class="container">
  <div class="page">
        <div class="header"><h1>status</h1></div>
        <p>To implement this command, edit the "Command implementation" section below.</p>

<div class="highlight"><pre>
<span class="c">#!/usr/bin/env bash</span>


</pre></div>

<h2>Usage</h2>

<div class="highlight"><pre>

</pre></div>

<p>Comments prefixed with <code>#/</code> are managed by stubbs.
The <code>command</code> and <code>usage</code> comments describe the command
and show its options.</p>

<div class="highlight"><pre>
<span class="c">#/ command: rundeck-run:status: &quot;check a rundeck execution status&quot;</span>
<span class="c">#/ usage: rerun rundeck-run:status  --id &lt;&gt;  --server-url &lt;&quot;${SERVER_URL:-}&quot;&gt;  --api-token &lt;${API_TOKEN:-}&gt; [ --detail] </span>

</pre></div>

<h2>Load common functions</h2>

<div class="highlight"><pre>

</pre></div>

<p>Load the function library for this module.
This loads rerun functions, too.</p>

<div class="highlight"><pre>
. <span class="nv">$RERUN_MODULE_DIR</span>/lib/functions.sh status <span class="o">||</span> <span class="o">{</span> 
  <span class="nb">echo</span> &gt;&amp;2 <span class="s2">&quot;Failed loading function library.&quot;</span> ; <span class="nb">exit </span>1 ; 
<span class="o">}</span>

</pre></div>

<h2>Error handling</h2>

<div class="highlight"><pre>

</pre></div>

<p>This script is designed to <em>fail-fast</em>.</p>

<div class="highlight"><pre>

</pre></div>

<p>Trap errors and exit. The call to <code>rerun_die</code> will print the
the error message and exit with the error command exit status. </p>

<div class="highlight"><pre>

<span class="nb">trap</span> <span class="s1">&#39;rerun_die $? &quot;*** command failed: rundeck-run:status. ***&quot;&#39;</span> ERR

</pre></div>

<p>Run [set] <code>nounset</code> to treat unset variables as errors. Set [pipefail]
so a pipeline return status is the value of the last 
(rightmost) command to exit with non-zero status.</p>

<div class="highlight"><pre>

<span class="nb">set</span> -o nounset -o pipefail

</pre></div>

<h2>Command variables</h2>

<div class="highlight"><pre>

</pre></div>

<p>This command script can access the following variables
declared by <code>rerun</code> or by the option parser function.</p>

<div class="highlight"><pre>

<span class="c">#/ rerun-variables: RERUN, RERUN_VERSION, RERUN_MODULES, RERUN_MODULE_DIR</span>
<span class="c">#/ option-variables: ID SERVER_URL API_TOKEN DETAIL</span>

</pre></div>

<p>The <code>rerun_options_parse</code> function processes the command line
arguments. Each accepted command line flag results in setting 
one the corresponding option variables.</p>

<div class="highlight"><pre>

rerun_options_parse <span class="s2">&quot;$@&quot;</span>


</pre></div>

<h2>Command implementation</h2>

<div class="highlight"><pre>

<span class="nv">CURL_OUT</span><span class="o">=</span><span class="k">$(</span>mktemp -t curl.out.XXXXXXXXXX<span class="k">)</span>

! <span class="nv">DATE</span><span class="o">=</span><span class="k">$(</span>which gdate<span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nv">DATE</span><span class="o">=</span>date
<span class="nv">tstamp</span><span class="o">=</span><span class="k">$(</span><span class="nv">$DATE</span> +%s%3N<span class="k">)</span>


<span class="k">if</span> ! <span class="nv">http_code</span><span class="o">=</span><span class="k">$(</span>rundeck_curl -w <span class="s2">&quot;%{http_code}&quot;</span> <span class="se">\</span>
	-H <span class="s1">&#39;Accept: application/xml&#39;</span> <span class="se">\</span>
	-H <span class="s2">&quot;X-Rundeck-Auth-Token: $API_TOKEN&quot;</span> <span class="se">\</span>
    -X GET <span class="s2">&quot;${SERVER_URL}/api/12/execution/$ID&quot;</span> <span class="se">\</span>
    -o <span class="nv">$CURL_OUT</span> 2&gt;/dev/null<span class="k">)</span>
<span class="k">then</span>
<span class="k">    case</span> <span class="k">${</span><span class="nv">http_code</span><span class="k">:-}</span> in
    	404<span class="o">)</span> rerun_die 3 <span class="s2">&quot;Failed getting status&quot;</span> ;;
		* <span class="o">)</span> rerun_die 3 <span class="s2">&quot;API error (HTTP response: $http_code, GET ${SERVER_URL}/api/12/execution/$ID).&quot;</span> ;;
	<span class="k">esac  </span>
<span class="k">fi</span>

<span class="c">#cat $CURL_OUT; echo</span>
<span class="nv">project</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//execution&quot;</span> -v @project <span class="nv">$CURL_OUT</span><span class="k">)</span>
<span class="nv">status</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//execution&quot;</span> -v @status <span class="nv">$CURL_OUT</span><span class="k">)</span>
<span class="nv">name</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//execution/job&quot;</span> -v name <span class="nv">$CURL_OUT</span><span class="k">)</span>
! <span class="nv">group</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//execution/job&quot;</span> -v group <span class="nv">$CURL_OUT</span><span class="k">)</span> <span class="o">&amp;&amp;</span> :
<span class="nv">dateStarted</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//execution/date-started&quot;</span> -v @unixtime <span class="nv">$CURL_OUT</span><span class="k">)</span>
! <span class="nv">dateEnded</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//execution/date-ended&quot;</span> -v @unixtime <span class="nv">$CURL_OUT</span><span class="k">)</span> <span class="o">&amp;&amp;</span> :
<span class="nv">execId</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//execution&quot;</span> -v @id <span class="nv">$CURL_OUT</span><span class="k">)</span>
<span class="nv">averageDuration</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//execution/job&quot;</span> -v @averageDuration <span class="nv">$CURL_OUT</span><span class="k">)</span>

<span class="k">case</span> <span class="s2">&quot;$status&quot;</span> in
	succeeded|failed|aborted<span class="o">)</span> 
		<span class="nv">duration</span><span class="o">=</span><span class="k">$((</span> <span class="o">(</span><span class="nv">$dateEnded</span> <span class="o">-</span> <span class="nv">$dateStarted</span><span class="o">)</span> <span class="o">/</span> <span class="m">1000</span> <span class="k">))</span>
		<span class="nb">printf</span> <span class="s2">&quot;%s execution - [%s: %s/%s] - %s - %ss duration\n&quot;</span> <span class="se">\</span>
			<span class="s2">&quot;$execId&quot;</span> <span class="s2">&quot;$project&quot;</span> <span class="s2">&quot;$group&quot;</span> <span class="s2">&quot;$name&quot;</span> <span class="s2">&quot;$status&quot;</span> <span class="s2">&quot;$duration&quot;</span>
		;;
	running<span class="o">)</span> 
</pre></div>

<p>Figure out elapsed time</p>

<div class="highlight"><pre>
		<span class="nv">elapsed_millis</span><span class="o">=</span><span class="k">$((</span> <span class="nv">$tstamp</span> <span class="o">-</span> <span class="nv">$dateStarted</span> <span class="k">))</span>
		<span class="nv">elapsed_secs</span><span class="o">=</span><span class="k">$((</span> <span class="nv">$elapsed_millis</span> <span class="o">/</span> <span class="m">1000</span> <span class="k">))</span>
		<span class="nv">pct_complete</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;scale=1; $elapsed_millis/$averageDuration *100&quot;</span> | bc<span class="k">)</span>

		<span class="nb">printf</span> <span class="s2">&quot;%s execution - [%s: %s/%s] - %s - %ss elapsed (~%s%%)\n&quot;</span> <span class="se">\</span>
			<span class="s2">&quot;$execId&quot;</span> <span class="s2">&quot;$project&quot;</span> <span class="s2">&quot;$group&quot;</span> <span class="s2">&quot;$name&quot;</span> <span class="s2">&quot;$status&quot;</span> <span class="s2">&quot;$elapsed_secs&quot;</span> <span class="s2">&quot;$pct_complete&quot;</span>
		;;		
<span class="k">esac</span>

<span class="o">[[</span> -n <span class="s2">&quot;$DETAIL&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span>
	<span class="nv">description</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//execution&quot;</span> -v description <span class="nv">$CURL_OUT</span><span class="k">)</span>
	<span class="nv">argstring</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//execution&quot;</span> -v argstring <span class="nv">$CURL_OUT</span><span class="k">)</span>
	<span class="nb">printf</span> <span class="s2">&quot;description: %s\n&quot;</span> <span class="s2">&quot;$description&quot;</span>
	<span class="nb">printf</span> <span class="s2">&quot;argstring: %s\n&quot;</span> <span class="s2">&quot;$argstring&quot;</span>

	<span class="k">if</span> ! <span class="nv">successfulNodes</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//successfulNodes/node&quot;</span> -v @name -o <span class="s2">&quot; &quot;</span> <span class="nv">$CURL_OUT</span><span class="k">)</span>
	<span class="k">then</span>
		:; <span class="c"># there were no successful nodes</span>
	<span class="k">else</span>
<span class="k">		</span><span class="nb">printf</span> <span class="s2">&quot;successful-nodes: %s\n&quot;</span> <span class="s2">&quot;$successfulNodes&quot;</span>				
	<span class="k">fi</span>

<span class="k">	if</span> ! <span class="nv">failedNodes</span><span class="o">=</span><span class="k">$(</span>xmlstarlet sel -t -m <span class="s2">&quot;//failedNodes/node&quot;</span> -v @name -o <span class="s2">&quot; &quot;</span> <span class="nv">$CURL_OUT</span><span class="k">)</span>
	<span class="k">then</span>
		:; <span class="c"># no failed nodes</span>
	<span class="k">else</span> 
</pre></div>

<p>there were failed nodes.</p>

<div class="highlight"><pre>
		<span class="nb">printf</span> <span class="s2">&quot;failed-nodes: %s\n&quot;</span> <span class="s2">&quot;$failedNodes&quot;</span>
	<span class="k">fi</span>
<span class="o">}</span>

</pre></div>

<p>Done. Exit with last command exit status.</p>

<div class="highlight"><pre>
<span class="nb">exit</span> <span class="nv">$?</span>



<div class="highlight"><pre>
</pre></div>

</pre></div>
<div class="highlight"><pre>

</pre></div>
  </div>
  <div class="fleur">h</div>

</div>
</body>
</html>
